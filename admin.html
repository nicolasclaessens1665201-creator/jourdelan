<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - Inscriptions Potluck</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      max-width: 1000px;
      margin: 0 auto;
      padding: 40px;
    }
    h1 {
      color: #667eea;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 16px;
    }
    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
    }
    .stat-value {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    .actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s;
    }
    button:hover {
      transform: translateY(-2px);
    }
    .btn-export {
      background: #4caf50;
      color: white;
    }
    .btn-clear {
      background: #f44336;
      color: white;
    }
    .btn-refresh {
      background: #2196F3;
      color: white;
    }
    .btn-back {
      background: #9e9e9e;
      color: white;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    thead {
      background: #f5f5f5;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    th {
      font-weight: 600;
      color: #333;
    }
    tr:hover {
      background: #f9f9f9;
    }
    .btn-delete {
      background: #f44336;
      color: white;
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 12px;
    }
    .btn-delete:hover {
      background: #d32f2f;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      table {
        font-size: 14px;
      }
      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéâ Administration - Inscriptions Potluck</h1>
    <p class="subtitle">Gestion des invit√©s pour le Jour de l'an</p>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-value" id="total-registrations">0</div>
        <div class="stat-label">Inscriptions</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-adults">0</div>
        <div class="stat-label">Adultes</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-children">0</div>
        <div class="stat-label">Enfants</div>
      </div>
      <div class="stat-card">
        <div class="stat-value" id="total-people">0</div>
        <div class="stat-label">Personnes totales</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-refresh" onclick="loadRegistrations()">üîÑ Actualiser</button>
      <button class="btn-export" onclick="exportToCSV()">üì• Exporter CSV</button>
      <button class="btn-export" onclick="exportToJSON()">üì• Exporter JSON</button>
      <button class="btn-clear" onclick="clearAllData()">üóëÔ∏è Effacer toutes les donn√©es</button>
      <button class="btn-back" onclick="window.location.href='inscription.html'">‚Üê Retour √† l'inscription</button>
    </div>

    <div id="table-container"></div>
  </div>

  <script>
    const STORAGE_KEY = 'potluck_registrations';
    const API_BASE = 'http://localhost:3000/api';

    function getRegistrations() {
      const data = localStorage.getItem(STORAGE_KEY);
      return data ? JSON.parse(data) : [];
    }

    function saveRegistrations(registrations) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(registrations));
    }

    function deleteRegistration(id) {
      if (!confirm('√ätes-vous s√ªr de vouloir supprimer cette inscription ?')) {
        return;
      }
      const registrations = getRegistrations();
      const filtered = registrations.filter(r => r.id !== id);
      saveRegistrations(filtered);
      loadRegistrations();
    }

    async function loadFromAPI() {
      try {
        const response = await fetch(`${API_BASE}/participants`);
        if (!response.ok) throw new Error('API not available');
        return await response.json();
      } catch (e) {
        console.log('API not available, using localStorage only');
        return [];
      }
    }

    async function loadRegistrations() {
      // Load from both sources
      const localRegistrations = getRegistrations();
      const apiParticipants = await loadFromAPI();
      
      // Combine both sources
      const registrations = [...localRegistrations, ...apiParticipants];
      const container = document.getElementById('table-container');

      // Update stats
      const totalAdults = registrations.reduce((sum, r) => sum + (r.adults || 0), 0);
      const totalChildren = registrations.reduce((sum, r) => sum + (r.children || 0), 0);
      const totalPeople = totalAdults + totalChildren;

      document.getElementById('total-registrations').textContent = registrations.length;
      document.getElementById('total-adults').textContent = totalAdults;
      document.getElementById('total-children').textContent = totalChildren;
      document.getElementById('total-people').textContent = totalPeople;

      if (registrations.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üì≠</div>
            <p>Aucune inscription pour le moment</p>
          </div>
        `;
        return;
      }

      // Sort by timestamp (most recent first)
      registrations.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      let html = `
        <table>
          <thead>
            <tr>
              <th>Nom</th>
              <th>Adultes</th>
              <th>Enfants</th>
              <th>Total</th>
              <th>Date d'inscription</th>
              <th>Source</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      registrations.forEach(reg => {
        const adults = reg.adults || 0;
        const children = reg.children || 0;
        const total = adults + children;
        const date = reg.timestamp ? new Date(reg.timestamp).toLocaleString('fr-FR') : 'N/A';
        const source = reg.timestamp ? 'üì± Inscription web' : 'üíª Participant app';
        
        html += `
          <tr>
            <td><strong>${reg.name}</strong></td>
            <td>${adults}</td>
            <td>${children}</td>
            <td><strong>${total}</strong></td>
            <td>${date}</td>
            <td><small>${source}</small></td>
            <td>
              <button class="btn-delete" onclick="deleteRegistration('${reg.id}')">Supprimer</button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
      `;

      container.innerHTML = html;
    }

    function exportToCSV() {
      const registrations = getRegistrations();
      if (registrations.length === 0) {
        alert('Aucune inscription √† exporter');
        return;
      }

      let csv = 'Nom,Adultes,Enfants,Total,Date d\'inscription\n';
      registrations.forEach(reg => {
        const adults = reg.adults || 0;
        const children = reg.children || 0;
        const total = adults + children;
        const date = new Date(reg.timestamp).toLocaleString('fr-FR');
        csv += `"${reg.name}",${adults},${children},${total},"${date}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `inscriptions_potluck_${Date.now()}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function exportToJSON() {
      const registrations = getRegistrations();
      if (registrations.length === 0) {
        alert('Aucune inscription √† exporter');
        return;
      }

      const json = JSON.stringify(registrations, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `inscriptions_potluck_${Date.now()}.json`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function clearAllData() {
      if (!confirm('‚ö†Ô∏è √ätes-vous ABSOLUMENT s√ªr de vouloir supprimer TOUTES les inscriptions ? Cette action est irr√©versible !')) {
        return;
      }
      if (!confirm('Derni√®re confirmation : toutes les donn√©es seront perdues !')) {
        return;
      }
      localStorage.removeItem(STORAGE_KEY);
      loadRegistrations();
      alert('Toutes les inscriptions ont √©t√© supprim√©es');
    }

    // Load on page load
    loadRegistrations();
  </script>
</body>
</html>
